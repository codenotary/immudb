name: pullCI

on: [pull_request]

jobs:
  build:
    name: build-and-test
    strategy:
      matrix:
        include:
          # - os: ubuntu-latest
          #   go: "1.15"

          # - os: ubuntu-latest
          #   go: "1.16"

          # - os: ubuntu-latest
          #   go: "1.17"

          - os: ubuntu-latest
            go: "1.18"
            testWithMinio: true

          # - os: ubuntu-latest
          #   go: "1.18"
          #   testWithFips: true

          # - os: ubuntu-latest
          #   go: "1.19"
          #   test: true

          # - os: windows-latest
          #   go: "1.18"
          #   testClientOnly: true
          #   noWebconsole: true

          # - os: macos-latest
          #   go: "1.18"
          #   testClientOnly: true

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/setup-go@v3
        with:
          go-version: ${{ matrix.go }}

      - uses: actions/checkout@v3

      - name: Test
        run: make test
        if: matrix.test

      - name: Test (with minio)
        run: |
          # Spawn minio docker container in the background
          docker run -d -t -p 9000:9000 --name minio \
            -e "MINIO_ACCESS_KEY=minioadmin" \
            -e "MINIO_SECRET_KEY=minioadmin" \
            minio/minio server /data

          # Create immudb bucket
          docker run --net=host -t --entrypoint /bin/sh minio/mc -c "
            mc alias set local http://localhost:9000 minioadmin minioadmin &&
            mc mb local/immudb
          "

          # Run go tests with minio
          GO_TEST_FLAGS="-tags minio" make test

          # Stop minio
          docker rm -f minio
        if: matrix.testWithMinio

      - name: Test (with fips build)
        run: |
          make test/fips
        if: matrix.testWithFips

      - name: Test Client
        run: make test-client
        if: matrix.testClientOnly
        shell: bash

