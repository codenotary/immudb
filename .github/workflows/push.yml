name: pushCI

on:
  push:
    branches: master

jobs:
  install_vcn:
    name: Install VCN
    runs-on: ubuntu-latest
    steps:
      - run: sudo apt update && sudo apt install curl -y
      - run: curl -L -o /tmp/vcn https://github.com/vchain-us/vcn/releases/download/v0.8.3/vcn-v0.8.3-linux-amd64-static
      - run: CHECKSUM=$(sha256sum /tmp/vcn | cut -d " " -f 1)
      - run: echo $CHECKSUM
      - run: curl -s https://api.codenotary.io/authenticate/$CHECKSUM?org=vchain.us | grep -q :0
      - run: chmod +x /tmp/vcn
  
  gosec:
    needs: install_vcn
    runs-on: ubuntu-latest
    steps:
      env:   
        JOB_NAME: ${{ github.job }}
        JOB_ID: ${{ github.run_id }}
      steps:
        - run: curl -sfL https://raw.githubusercontent.com/securego/gosec/master/install.sh | sudo sh -s -- -b $GOPATH/bin latest
        - run: gosec -fmt=json -out=results-$JOB_ID.json -no-fail ./...
        - run: VCN_USER=$gosec_user VCN_PASSWORD=$gosec_pass /tmp/vcn login
        - run: VCN_NOTARIZATION_PASSWORD=$gosec_pass /tmp/vcn n -p --attr GHJobName=$JOB_NAME --attr GHJobNo=$JOB_ID --attr  --silent results-$JOB_ID.json
        - run: /tmp/vcn logout
        - run: sleep $[ ( $RANDOM % 10 ) + 1 ]s
        - run: VCN_USER=$trv_user VCN_PASSWORD=$trv_pass /tmp/vcn login
        - run: VCN_NOTARIZATION_PASSWORD=$trv_pass /tmp/vcn n -p --attr GHJobName=$JOB_NAME --attr GHJobNo=$JOB_ID --silent results-$JOB_ID.json
        - run: /tmp/vcn logout

  binaries:
      name: Build and notarize binaries
      needs: gosec
      runs-on: ubuntu-latest
      steps:
        env:   
          JOB_NAME: ${{ github.job }}
          JOB_ID: ${{ github.run_id }}
        steps:
          - run: GOOS=linux GOARCH=amd64 make immudb-static immuadmin-static immuclient-static
          - run: VCN_USER=$trv_user VCN_PASSWORD=$trv_pass /tmp/vcn login
          - run: VCN_NOTARIZATION_PASSWORD=$trv_pass /tmp/vcn n -p --attr GHJobName=$JOB_NAME --attr GHJobNo=$JOB_ID --silent immudb
          - run: sleep $[ ( $RANDOM % 10 ) + 1 ]s
          - run: VCN_NOTARIZATION_PASSWORD=$trv_pass /tmp/vcn n -p --attr GHJobName=$JOB_NAME --attr GHJobNo=$JOB_ID --silent immuadmin
          - run: sleep $[ ( $RANDOM % 10 ) + 1 ]s
          - run: VCN_NOTARIZATION_PASSWORD=$trv_pass /tmp/vcn n -p --attr GHJobName=$JOB_NAME --attr GHJobNo=$JOB_ID --silent immuclient
          - run: /tmp/vcn logout
        with:
          name: bin
          path: |
            ./immudb
            ./immuadmin
            ./immuclient

  coveralls:
    name: Publish coverage
    needs: gosec
    runs-on: ubuntu-latest
    env:   
        COVERALLS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps: 
      - run: go get golang.org/x/tools/cmd/cover
      - run: go get github.com/mattn/goveralls
      - run: go get -u github.com/ory/go-acc
      - run: set -o pipefail
      - run: go-acc ./... --ignore test || true
      - run: cat coverage.txt | grep -v "schema.pb" > cover.out
      - run: $HOME/gopath/bin/goveralls -coverprofile=cover.out -service=travis-ci -repotoken $COVERALLS_TOKEN
  
