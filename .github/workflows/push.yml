name: pushCI

on:
  push:
    branches: master, ci_GH_actions

jobs:
  install_vcn:
    name: Install VCN
    runs-on: ubuntu-latest
    steps:
      - run: |
          sudo apt update && sudo apt install curl -y
          curl -L -o /tmp/vcn https://github.com/vchain-us/vcn/releases/download/v0.8.3/vcn-v0.8.3-linux-amd64-static
          CHECKSUM=$(sha256sum /tmp/vcn | cut -d " " -f 1)
          echo $CHECKSUM
          curl -s https://api.codenotary.io/authenticate/$CHECKSUM?org=vchain.us | grep -q :0
          chmod +x /tmp/vcn
  
  gosec:
    needs: install_vcn
    runs-on: ubuntu-latest
    steps:
      - run: |
          curl -sfL https://raw.githubusercontent.com/securego/gosec/master/install.sh | sudo sh -s -- -b $GOPATH/bin latest
          gosec -fmt=json -out=results-$JOB_ID.json -no-fail ./...
          VCN_USER=$gosec_user VCN_PASSWORD=$gosec_pass /tmp/vcn login
          VCN_NOTARIZATION_PASSWORD=$gosec_pass /tmp/vcn n -p --attr GHJobName=$JOB_NAME --attr GHJobNo=$JOB_ID --attr  --silent results-$JOB_ID.json
          /tmp/vcn logout
          sleep $[ ( $RANDOM % 10 ) + 1 ]s
          VCN_USER=$trv_user VCN_PASSWORD=$trv_pass /tmp/vcn login
          VCN_NOTARIZATION_PASSWORD=$trv_pass /tmp/vcn n -p --attr GHJobName=$JOB_NAME --attr GHJobNo=$JOB_ID --silent results-$JOB_ID.json
          /tmp/vcn logout
        env:   
          JOB_NAME: ${{ github.job }}
          JOB_ID: ${{ github.run_id }}

  binaries:
      name: Build and notarize binaries
      needs: gosec
      runs-on: ubuntu-latest
      steps:
        - run: |
            GOOS=linux GOARCH=amd64 make immudb-static immuadmin-static immuclient-static
            VCN_USER=$trv_user VCN_PASSWORD=$trv_pass /tmp/vcn login
            VCN_NOTARIZATION_PASSWORD=$trv_pass /tmp/vcn n -p --attr GHJobName=$JOB_NAME --attr GHJobNo=$JOB_ID --silent immudb
            sleep $[ ( $RANDOM % 10 ) + 1 ]s
            VCN_NOTARIZATION_PASSWORD=$trv_pass /tmp/vcn n -p --attr GHJobName=$JOB_NAME --attr GHJobNo=$JOB_ID --silent immuadmin
            sleep $[ ( $RANDOM % 10 ) + 1 ]s
            VCN_NOTARIZATION_PASSWORD=$trv_pass /tmp/vcn n -p --attr GHJobName=$JOB_NAME --attr GHJobNo=$JOB_ID --silent immuclient
            /tmp/vcn logout
          env:
            JOB_NAME: ${{ github.job }}
            JOB_ID: ${{ github.run_id }}

  coveralls:
    name: Publish coverage
    needs: gosec
    runs-on: ubuntu-latest
    env:   
        COVERALLS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps: 
      - run: |
          go get golang.org/x/tools/cmd/cover
          go get github.com/mattn/goveralls
          go get -u github.com/ory/go-acc
          set -o pipefail
          go-acc ./... --ignore test || true
          cat coverage.txt | grep -v "schema.pb" > cover.out
          $HOME/gopath/bin/goveralls -coverprofile=cover.out -service=travis-ci -repotoken $COVERALLS_TOKEN
  
